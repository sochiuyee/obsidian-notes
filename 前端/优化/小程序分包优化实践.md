查看小程序主包分包体积方法：[[小程序打包体积]]

🔗 https://mp.weixin.qq.com/s/-oA3BIQh5irPHqcTidwWCw

>[!INFO]
>各大平台对小程序的主包有限制，例如微信平台限制就2M。为了防止主包超限，以及更好地多人协作，开发人员可以对小程序进行分包，如将一组独立的功能页面作为分包打包

==小程序包加载流程图==
![[微信图片_20230208194751.png]]


>[!CITE]  存在的问题😬：图片资源过大，影响主包体积
>建议将图片资源上传到 CDN，优先使用 CDN 图片。如有 tabbar 等必须用本地图片的情况，建议将本地图片压缩后再进行引入

----

>[!CITE]  存在的问题😬：第三方包引入不规范，导致打包后引入冗余代码；

==例子：引入第三方工具lodash==
```js
// import _ from 'lodash'; 直接引入npm方式，并没有打包压缩

import './libs/lodash-fix.js'; // 修复引用min的错误
import _ from './libs/lodash@4.17.15.min.js';

/*
* 1. npm此方式引入的包体积很大，占用了533KB,而微信单包体积允许2M
* 2. 上传代码时，微信开发者工具并没有将lodash包进行打包压缩
* 3. 所以采用min.js方式，以减少包体积
*/
```
| 方式 | 包体积 | 推荐 |
| ---- | ------ | ---- |
|  npm  | 533KB  | ❌   |
| min。  | 533KB  | ✅   |


###### 优化引入方式减少打包体积
```js
import { get } from 'lodash' // 直接引入后打包出来的体积 lodash 包大小为 117KB。
```

```js
import get from 'lodash/get'  
import isEmpty from 'lodash/isEmpty'

/*
* 可以看到，优化引入方式后 lodash 包大小只有 46KB，使主包体积减少了 60%。
* 除了上述优化方法，还可以将 lodash 替换为“lodash-es”，“lodash-es”基于 ESM 打包方式，这样就能利用 tree-shaking 移除不必要的代码，同时还能保留了按需引入的写法。
*/
```

---

>[!CITE] 存在的问题😬：console、debugger 等测试代码未做优化，需要上线前手动删除；
```js
// 使用 webpack-parallel-uglify-plugin进行代码压缩
var ParallelUglifyPlugin = require('webpack-parallel-uglify-plugin'); 
plugins: {
	new ParallelUglifyPlugin({ 
		uglifyJS: { 
			output: { 
				comments: false //去掉注释 
			}, 
			compress: { 
				warnings: false, 
				drop_debugger: true, // 去掉debugger
				drop_console: true // 去掉console
			} 
		} 
	})
}

// 使用插件压缩工具，删除console和debugger和注释，减少包代码体积。
```

---

>[!CITE]  采用构建时进行多端小程序代码兼容

如果代码是用taro等工具，适应多个平台的小程序，对于某些平台特有的功能，构建后只含有该平台的代码

[Taro 编译时环境变量：]:https://taro-docs.jd.com/docs/envs#processenvtaro_env

```js
// 使用不同的编译环境变量，打包编译后只有该平台会有该段的代码
const isJD = process.env.TARO_ENV === 'jd'  
function test() {  
  if (isJD) {  
    console.log('京东小程序特定功能')  
  }  
}

// 京东小程序  
function test() {  
  console.log('京东小程序特定功能')  
}  
// 非京东小程序  
function test() {}
```
通过动态判断 process.env.TARO_ENV，构建后小程序只包含了自己平台相关的代码，大大减少了包体积（请注意区分 <font color="#31859b">process.env.TARO_ENV</font> 和<font color="#5f497a"> Taro.getEnv()</font>，前者是<font color="#31859b">编译构建时的变量</font>，后者是<font color="#5f497a">运行时的变量</font>）。
